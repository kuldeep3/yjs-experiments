import{getVersion as e,subscribe as t,proxy as s}from"valtio/vanilla";import*as n from"yjs";import r from"fast-deep-equal";const o=t=>"object"==typeof t&&null!==t&&void 0!==e(t),i=t=>Array.isArray(t)&&void 0!==e(t),a=e=>null===e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e,l=e=>"string"==typeof e||"number"==typeof e||"boolean"==typeof e,c=(e,t,s)=>{e?e.transact(s,t.transactionOrigin):s()},f=(e,l,y={})=>{const u=new WeakMap,d=(e,t)=>{c(l.doc,y,()=>{if(!o(e)||!u.has(e)||u.get(e)!==l.get(t))if(i(e)){const s=new n.Array;u.set(e,s),p(e,s,y),l.set(t,s)}else if(o(e)){const s=new n.Map;u.set(e,s),f(e,s,y),l.set(t,s)}else a(e)?l.set(t,e):"production"!==process.env.NODE_ENV&&console.warn("unsupported p type",e)})},g=(t,r)=>{const i=e[r];if(!o(i)||u.get(i)!==t)if(t instanceof n.Array){const n=s([]);u.set(n,t),p(n,t,y),e[r]=n}else if(t instanceof n.Map){const n=s(t.toJSON());u.set(n,t),f(n,t,y),e[r]=n}else a(t)?e[r]=t:"production"!==process.env.NODE_ENV&&console.warn("unsupported y type",t)};Object.entries(e).forEach(([e,t])=>{const s=l.get(e);i(t)&&s instanceof n.Array&&r(t,s.toJSON())?(u.set(t,s),p(t,s,y)):!Array.isArray(t)&&o(t)&&s instanceof n.Map&&r(t,s.toJSON())?(u.set(t,s),f(t,s,y)):d(t,e)}),l.forEach((t,s)=>{const a=e[s];i(a)&&t instanceof n.Array&&r(a,t.toJSON())?(u.set(a,t),p(a,t,y)):!Array.isArray(a)&&o(a)&&t instanceof n.Map&&r(a,t.toJSON())?(u.set(a,t),f(a,t,y)):g(t,s)}),t(e,t=>{t.forEach(t=>{const s=t[1];if(1!==s.length)return;const o=s[0];if("delete"===t[0])l.delete(o);else if("set"===t[0]){const t=e[o],s=l.get(o);r(s instanceof n.AbstractType?s.toJSON():s,t)||d(t,o)}})}),l.observe(t=>{t.keysChanged.forEach(t=>{const s=l.get(t);void 0===s?delete e[t]:g(s,t)})})},p=(e,a,y={})=>{const u=new WeakMap,d=(e,t)=>{if(i(e)){const s=new n.Array;u.set(e,s),p(e,s,y),a.insert(t,[s])}else if(o(e)){const s=new n.Map;u.set(e,s),f(e,s,y),a.insert(t,[s])}else{if(!l(e))throw new Error("unsupported p type");a.insert(t,[e])}},g=(t,r)=>{if(t instanceof n.Array){const n=s([]);u.set(n,t),p(n,t,y),e.splice(r,0,n)}else if(t instanceof n.Map){const n=s(t.toJSON());u.set(n,t),f(n,t),e.splice(r,0,n)}else{if(!l(t))throw new Error("unsupported y type");e.splice(r,0,t)}};e.forEach((e,t)=>{const s=a.get(t);i(e)&&s instanceof n.Array&&r(e,s.toJSON())?u.get(e)!==s&&(u.set(e,s),p(e,s,y)):!Array.isArray(e)&&o(e)&&s instanceof n.Map&&r(e,s.toJSON())?u.get(e)!==s&&(u.set(e,s),f(e,s,y)):l(e)&&l(s)&&e===s||d(e,t)}),a.forEach((t,s)=>{const a=e[s];i(a)&&t instanceof n.Array&&r(a,t.toJSON())?u.get(a)!==t&&(u.set(a,t),p(a,t,y)):!Array.isArray(a)&&o(a)&&t instanceof n.Map&&r(a,t.toJSON())?u.get(a)!==t&&(u.set(a,t),f(a,t,y)):l(a)&&l(t)&&a===t||g(t,s)}),e.splice(a.length),t(e,t=>{const s=(e=>{const t=e.flatMap(e=>{if("resolve"===e[0]||"reject"===e[0])return[];if(1!==e[1].length)return[];const t=Number(e[1][0]);return Number.isFinite(t)?[[e[0],t,e[2],e[3]]]:[]}),s=(e,s)=>{let n=0,r=null;for(;e+n+1<t.length;){if(("set"===t[e+n+1][0]||"insert"===t[e+n+1][0])&&t[e+n+1][1]<s&&t[e+n+1][3]===t[e][2])return n+1;if(null!==r||"set"!==t[e+n+1][0]&&"insert"!==t[e+n+1][0]||t[e+n+1][1]!==s-(n+1)||void 0!==t[e+n+1][3])if(null===r&&e+n+1<t.length&&"set"===t[e+n+1][0]&&void 0!==t[e+n+1][3])r=[e+n+1,t[e+n+1][1]],n+=1;else{if(null===r||"set"!==t[e+n+1][0]||t[e+n+1][1]!==r[1]+(n+1-r[0])||void 0===t[e+n+1][3])return null;n+=1}else n+=1}return null},n=(e,s)=>{let n=0;for(;e+n+1<t.length&&"delete"===t[e+n+1][0]&&t[e+n+1][1]===s-(n+1);)n+=1;return n};let r=0;for(;r<t.length;)if("set"!==t[r][0]&&"insert"!==t[r][0]||void 0!==t[r][3])if(r>0&&"delete"===t[r][0]){const e=t[r][1],s=n(r,e);if("set"===t[r-1][0]&&t[r-1][1]===e-(s+1)&&t[r-1][2]===t[r][2]){const n=["delete",e-(s+1),t[r-1][3],void 0];t.splice(r-1,2),t.splice(r-1+s,0,n),r-=1}else r+=1}else r+=1;else{const e=s(r,t[r][1]);null!==e?(t.splice(r+e,1,["insert",t[r+e][1],t[r+e][2],void 0]),t.splice(r,1)):r+=1}return t})(t);r(a.toJSON(),e)||c(a.doc,y,()=>{s.forEach(t=>{const s=t[1];if("delete"===t[0])return void(a.length>s&&a.delete(s,1));const n=e[s];void 0!==n&&("set"===t[0]?(a.length>s&&a.delete(s,1),d(n,s)):"insert"===t[0]&&d(n,s))})})}),a.observe(t=>{if(r(e,a.toJSON()))return;let s=0;t.changes.delta.forEach(t=>{t.retain&&(s+=t.retain),t.delete&&e.splice(s,t.delete),t.insert&&(Array.isArray(t.insert)?t.insert.forEach((e,t)=>{g(e,s+t)}):g(t.insert,s),s+=t.insert.length)})})};export{p as bindProxyAndYArray,f as bindProxyAndYMap};
//# sourceMappingURL=index.modern.mjs.map
