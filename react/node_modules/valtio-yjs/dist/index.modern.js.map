{"version":3,"file":"index.modern.mjs","sources":["../src/index.ts","../src/parseProxyOps.ts"],"sourcesContent":["import { proxy, subscribe, getVersion } from 'valtio/vanilla';\nimport * as Y from 'yjs';\nimport deepEqual from 'fast-deep-equal';\nimport { parseProxyOps } from './parseProxyOps';\n\nconst isProxyObject = <T>(x: T): x is T & Record<string, unknown> =>\n  typeof x === 'object' && x !== null && getVersion(x) !== undefined;\n\nconst isProxyArray = <T>(x: T): x is T & unknown[] =>\n  Array.isArray(x) && getVersion(x) !== undefined;\n\nconst isPrimitiveMapValue = (v: unknown) =>\n  v === null ||\n  typeof v === 'string' ||\n  typeof v === 'number' ||\n  typeof v === 'boolean';\n\nconst isPrimitiveArrayValue = (v: unknown) =>\n  typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean';\n\ntype Options = {\n  transactionOrigin?: any;\n};\n\nconst transact = (doc: Y.Doc | null, opts: Options, fn: () => void) => {\n  if (doc) {\n    doc.transact(fn, opts.transactionOrigin);\n  } else {\n    fn();\n  }\n};\n\nexport const bindProxyAndYMap = <T>(\n  p: Record<string, T>,\n  y: Y.Map<T>,\n  opts: Options = {},\n) => {\n  const pv2yvCache = new WeakMap<object, unknown>();\n\n  const setPValueToY = (pv: T, k: string) => {\n    transact(y.doc, opts, () => {\n      if (\n        isProxyObject(pv) &&\n        pv2yvCache.has(pv) &&\n        pv2yvCache.get(pv) === y.get(k)\n      ) {\n        return;\n      }\n      if (isProxyArray(pv)) {\n        const yv = new Y.Array();\n        pv2yvCache.set(pv, yv);\n        bindProxyAndYArray(pv, yv, opts);\n        y.set(k, yv as unknown as T);\n      } else if (isProxyObject(pv)) {\n        const yv = new Y.Map();\n        pv2yvCache.set(pv, yv);\n        bindProxyAndYMap(pv, yv, opts);\n        y.set(k, yv as unknown as T);\n      } else if (isPrimitiveMapValue(pv)) {\n        y.set(k, pv);\n      } else if (process.env.NODE_ENV !== 'production') {\n        console.warn('unsupported p type', pv);\n      }\n    });\n  };\n\n  const setYValueToP = (yv: T, k: string) => {\n    const prev = p[k];\n    if (isProxyObject(prev) && pv2yvCache.get(prev) === yv) {\n      return;\n    }\n    if (yv instanceof Y.Array) {\n      const pv = proxy([]);\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYArray(pv, yv, opts);\n      p[k] = pv as unknown as T;\n    } else if (yv instanceof Y.Map) {\n      const pv = proxy(yv.toJSON());\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYMap(pv, yv, opts);\n      p[k] = pv as unknown as T;\n    } else if (isPrimitiveMapValue(yv)) {\n      p[k] = yv;\n    } else if (process.env.NODE_ENV !== 'production') {\n      console.warn('unsupported y type', yv);\n    }\n  };\n\n  // initialize from p\n  Object.entries(p).forEach(([k, pv]) => {\n    const yv = y.get(k);\n    if (\n      isProxyArray(pv) &&\n      yv instanceof Y.Array &&\n      deepEqual(pv, yv.toJSON())\n    ) {\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYArray(pv, yv, opts);\n    } else if (\n      !Array.isArray(pv) &&\n      isProxyObject(pv) &&\n      yv instanceof Y.Map &&\n      deepEqual(pv, yv.toJSON())\n    ) {\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYMap(pv, yv, opts);\n    } else {\n      setPValueToY(pv, k);\n    }\n  });\n\n  // initialize from y\n  y.forEach((yv, k) => {\n    const pv = p[k];\n    if (\n      isProxyArray(pv) &&\n      yv instanceof Y.Array &&\n      deepEqual(pv, yv.toJSON())\n    ) {\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYArray(pv, yv, opts);\n    } else if (\n      !Array.isArray(pv) &&\n      isProxyObject(pv) &&\n      yv instanceof Y.Map &&\n      deepEqual(pv, yv.toJSON())\n    ) {\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYMap(pv, yv, opts);\n    } else {\n      setYValueToP(yv, k);\n    }\n  });\n\n  // subscribe p\n  subscribe(p, (ops) => {\n    ops.forEach((op) => {\n      const path = op[1];\n      if (path.length !== 1) {\n        return;\n      }\n      const k = path[0] as string;\n      if (op[0] === 'delete') {\n        y.delete(k);\n      } else if (op[0] === 'set') {\n        const pv = p[k];\n        const yv = y.get(k);\n        if (!deepEqual(yv instanceof Y.AbstractType ? yv.toJSON() : yv, pv)) {\n          setPValueToY(pv, k);\n        }\n      }\n    });\n  });\n\n  // subscribe y\n  y.observe((event) => {\n    event.keysChanged.forEach((k) => {\n      const yv = y.get(k);\n      if (yv === undefined) {\n        delete p[k];\n      } else {\n        setYValueToP(yv, k);\n      }\n    });\n  });\n};\n\nexport const bindProxyAndYArray = <T>(\n  p: T[],\n  y: Y.Array<T>,\n  opts: Options = {},\n) => {\n  const pv2yvCache = new WeakMap<object, unknown>();\n\n  const insertPValueToY = (pv: T, i: number) => {\n    if (isProxyArray(pv)) {\n      const yv = new Y.Array();\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYArray(pv, yv, opts);\n      y.insert(i, [yv as unknown as T]);\n    } else if (isProxyObject(pv)) {\n      const yv = new Y.Map();\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYMap(pv, yv, opts);\n      y.insert(i, [yv as unknown as T]);\n    } else if (isPrimitiveArrayValue(pv)) {\n      y.insert(i, [pv]);\n    } else {\n      throw new Error('unsupported p type');\n    }\n  };\n\n  const insertYValueToP = (yv: T, i: number) => {\n    if (yv instanceof Y.Array) {\n      const pv = proxy([]);\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYArray(pv, yv, opts);\n      p.splice(i, 0, pv as unknown as T);\n    } else if (yv instanceof Y.Map) {\n      const pv = proxy(yv.toJSON());\n      pv2yvCache.set(pv, yv);\n      bindProxyAndYMap(pv, yv);\n      p.splice(i, 0, pv as unknown as T);\n    } else if (isPrimitiveArrayValue(yv)) {\n      p.splice(i, 0, yv);\n    } else {\n      throw new Error('unsupported y type');\n    }\n  };\n\n  // initialize from p\n  p.forEach((pv, i) => {\n    const yv = y.get(i);\n    if (\n      isProxyArray(pv) &&\n      yv instanceof Y.Array &&\n      deepEqual(pv, yv.toJSON())\n    ) {\n      if (pv2yvCache.get(pv) !== yv) {\n        pv2yvCache.set(pv, yv);\n        bindProxyAndYArray(pv, yv, opts);\n      }\n    } else if (\n      !Array.isArray(pv) &&\n      isProxyObject(pv) &&\n      yv instanceof Y.Map &&\n      deepEqual(pv, yv.toJSON())\n    ) {\n      if (pv2yvCache.get(pv) !== yv) {\n        pv2yvCache.set(pv, yv);\n        bindProxyAndYMap(pv, yv, opts);\n      }\n    } else if (\n      isPrimitiveArrayValue(pv) &&\n      isPrimitiveArrayValue(yv) &&\n      pv === yv\n    ) {\n      // do nothing\n    } else {\n      insertPValueToY(pv, i);\n    }\n  });\n\n  // initialize from y\n  y.forEach((yv, i) => {\n    const pv = p[i];\n    if (\n      isProxyArray(pv) &&\n      yv instanceof Y.Array &&\n      deepEqual(pv, yv.toJSON())\n    ) {\n      if (pv2yvCache.get(pv) !== yv) {\n        pv2yvCache.set(pv, yv);\n        bindProxyAndYArray(pv, yv, opts);\n      }\n    } else if (\n      !Array.isArray(pv) &&\n      isProxyObject(pv) &&\n      yv instanceof Y.Map &&\n      deepEqual(pv, yv.toJSON())\n    ) {\n      if (pv2yvCache.get(pv) !== yv) {\n        pv2yvCache.set(pv, yv);\n        bindProxyAndYMap(pv, yv, opts);\n      }\n    } else if (\n      isPrimitiveArrayValue(pv) &&\n      isPrimitiveArrayValue(yv) &&\n      pv === yv\n    ) {\n      // do nothing\n    } else {\n      insertYValueToP(yv, i);\n    }\n  });\n\n  // strip p\n  p.splice(y.length);\n\n  // subscribe p\n  subscribe(p, (ops) => {\n    const arrayOps = parseProxyOps(ops);\n    if (deepEqual(y.toJSON(), p)) {\n      return;\n    }\n    transact(y.doc, opts, () => {\n      arrayOps.forEach((op) => {\n        const i = op[1];\n        if (op[0] === 'delete') {\n          if (y.length > i) {\n            y.delete(i, 1);\n          }\n          return;\n        }\n        const pv = p[i];\n        if (pv === undefined) {\n          return;\n        }\n        if (op[0] === 'set') {\n          if (y.length > i) {\n            y.delete(i, 1);\n          }\n          insertPValueToY(pv, i);\n        } else if (op[0] === 'insert') {\n          insertPValueToY(pv, i);\n        }\n      });\n    });\n  });\n\n  // subscribe y\n  y.observe((event) => {\n    if (deepEqual(p, y.toJSON())) {\n      return;\n    }\n    let retain = 0;\n    event.changes.delta.forEach((item) => {\n      if (item.retain) {\n        retain += item.retain;\n      }\n      if (item.delete) {\n        p.splice(retain, item.delete);\n      }\n      if (item.insert) {\n        if (Array.isArray(item.insert)) {\n          item.insert.forEach((yv, i) => {\n            insertYValueToP(yv, retain + i);\n          });\n        } else {\n          insertYValueToP(item.insert as unknown as T, retain);\n        }\n        retain += item.insert.length;\n      }\n    });\n  });\n};\n","import { subscribe } from 'valtio/vanilla';\n\ntype Op = Parameters<Parameters<typeof subscribe>[1]>[0][number];\ntype ArrayOp = [\n  op: 'insert' | 'set' | 'delete',\n  index: number,\n  value1: unknown,\n  value2: unknown,\n];\n\nexport const parseProxyOps = (ops: Op[]): ArrayOp[] => {\n  const arrayOps: ArrayOp[] = ops.flatMap((op) => {\n    if (op[0] === 'resolve' || op[0] === 'reject') return [];\n    if (op[1].length !== 1) return [];\n    const index = Number(op[1][0]);\n    if (!Number.isFinite(index)) return [];\n    return [[op[0], index, op[2], op[3]]];\n  });\n\n  const findCorrespondingInsert = (\n    startOpIndex: number,\n    startArrayIndex: number,\n  ) => {\n    let s = 0;\n    let noInsert: [startOpIndex: number, startArrayIndex: number] | null = null;\n    while (startOpIndex + s + 1 < arrayOps.length) {\n      if (\n        (arrayOps[startOpIndex + s + 1][0] === 'set' ||\n          arrayOps[startOpIndex + s + 1][0] === 'insert') &&\n        arrayOps[startOpIndex + s + 1][1] < startArrayIndex &&\n        arrayOps[startOpIndex + s + 1][3] === arrayOps[startOpIndex][2]\n      ) {\n        return s + 1;\n      }\n      if (\n        noInsert === null &&\n        (arrayOps[startOpIndex + s + 1][0] === 'set' ||\n          arrayOps[startOpIndex + s + 1][0] === 'insert') &&\n        arrayOps[startOpIndex + s + 1][1] === startArrayIndex - (s + 1) &&\n        arrayOps[startOpIndex + s + 1][3] === undefined\n      ) {\n        s += 1;\n      } else if (\n        noInsert === null &&\n        startOpIndex + s + 1 < arrayOps.length &&\n        arrayOps[startOpIndex + s + 1][0] === 'set' &&\n        arrayOps[startOpIndex + s + 1][3] !== undefined\n      ) {\n        noInsert = [startOpIndex + s + 1, arrayOps[startOpIndex + s + 1][1]];\n        s += 1;\n      } else if (\n        noInsert !== null &&\n        arrayOps[startOpIndex + s + 1][0] === 'set' &&\n        arrayOps[startOpIndex + s + 1][1] ===\n          noInsert[1] + (s + 1 - noInsert[0]) &&\n        arrayOps[startOpIndex + s + 1][3] !== undefined\n      ) {\n        s += 1;\n      } else {\n        return null;\n      }\n    }\n    return null;\n  };\n\n  const findContinuousDelete = (\n    startOpIndex: number,\n    startArrayIndex: number,\n  ) => {\n    let d = 0;\n    while (\n      startOpIndex + d + 1 < arrayOps.length &&\n      arrayOps[startOpIndex + d + 1][0] === 'delete' &&\n      arrayOps[startOpIndex + d + 1][1] === startArrayIndex - (d + 1)\n    ) {\n      d += 1;\n    }\n    return d;\n  };\n\n  let i = 0;\n  while (i < arrayOps.length) {\n    if (\n      (arrayOps[i][0] === 'set' || arrayOps[i][0] === 'insert') &&\n      arrayOps[i][3] === undefined\n    ) {\n      const startArrayIndex = arrayOps[i][1];\n      const s = findCorrespondingInsert(i, startArrayIndex);\n      if (s !== null) {\n        const newArrayOp: ArrayOp = [\n          'insert',\n          arrayOps[i + s][1],\n          arrayOps[i + s][2],\n          undefined,\n        ];\n        arrayOps.splice(i + s, 1, newArrayOp);\n        arrayOps.splice(i, 1);\n      } else {\n        i += 1;\n      }\n    } else if (i > 0 && arrayOps[i][0] === 'delete') {\n      const startArrayIndex = arrayOps[i][1];\n      const d = findContinuousDelete(i, startArrayIndex);\n      if (\n        arrayOps[i - 1][0] === 'set' &&\n        arrayOps[i - 1][1] === startArrayIndex - (d + 1) &&\n        arrayOps[i - 1][2] === arrayOps[i][2]\n      ) {\n        const newArrayOp: ArrayOp = [\n          'delete',\n          startArrayIndex - (d + 1),\n          arrayOps[i - 1][3],\n          undefined,\n        ];\n        arrayOps.splice(i - 1, 2);\n        arrayOps.splice(i - 1 + d, 0, newArrayOp);\n        i -= 1;\n      } else {\n        i += 1;\n      }\n    } else {\n      i += 1;\n    }\n  }\n\n  return arrayOps;\n};\n"],"names":["isProxyObject","x","undefined","getVersion","isProxyArray","Array","isArray","isPrimitiveMapValue","v","isPrimitiveArrayValue","transact","doc","opts","fn","transactionOrigin","bindProxyAndYMap","p","y","pv2yvCache","WeakMap","setPValueToY","pv","k","has","get","yv","Y","set","bindProxyAndYArray","Map","process","env","NODE_ENV","console","warn","setYValueToP","prev","proxy","toJSON","Object","entries","forEach","deepEqual","subscribe","ops","op","path","length","delete","AbstractType","observe","event","keysChanged","insertPValueToY","i","insert","Error","insertYValueToP","splice","arrayOps","flatMap","index","Number","isFinite","findCorrespondingInsert","startOpIndex","startArrayIndex","s","noInsert","findContinuousDelete","d","newArrayOp","parseProxyOps","retain","changes","delta","item"],"mappings":"iIAKMA,EAAoBC,GACX,iBAANA,GAAwB,OAANA,QAAgCC,IAAlBC,EAAWF,GAE9CG,EAAmBH,GACvBI,MAAMC,QAAQL,SAAwBC,IAAlBC,EAAWF,GAE3BM,EAAuBC,GACrB,OAANA,GACa,iBAANA,GACM,iBAANA,GACM,kBAANA,EAEHC,EAAyBD,GAChB,iBAANA,GAA+B,iBAANA,GAA+B,kBAANA,EAMrDE,EAAW,CAACC,EAAmBC,EAAeC,KAC9CF,EACFA,EAAID,SAASG,EAAID,EAAKE,mBAEtBD,KAISE,EAAmB,CAC9BC,EACAC,EACAL,EAAgB,MAEhB,MAAMM,EAAa,IAAIC,QAEjBC,EAAe,CAACC,EAAOC,KAC3BZ,EAASO,EAAEN,IAAKC,EAAM,KACpB,IACEZ,EAAcqB,KACdH,EAAWK,IAAIF,IACfH,EAAWM,IAAIH,KAAQJ,EAAEO,IAAIF,GAI/B,GAAIlB,EAAaiB,GAAK,CACpB,MAAMI,EAAK,IAAIC,EAAErB,MACjBa,EAAWS,IAAIN,EAAII,GACnBG,EAAmBP,EAAII,EAAIb,GAC3BK,EAAEU,IAAIL,EAAGG,WACAzB,EAAcqB,GAAK,CAC5B,MAAMI,EAAK,IAAIC,EAAEG,IACjBX,EAAWS,IAAIN,EAAII,GACnBV,EAAiBM,EAAII,EAAIb,GACzBK,EAAEU,IAAIL,EAAGG,QACAlB,EAAoBc,GAC7BJ,EAAEU,IAAIL,EAAGD,GACyB,eAAzBS,QAAQC,IAAIC,UACrBC,QAAQC,KAAK,qBAAsBb,MAKnCc,EAAe,CAACV,EAAOH,KAC3B,MAAMc,EAAOpB,EAAEM,GACf,IAAItB,EAAcoC,IAASlB,EAAWM,IAAIY,KAAUX,EAGpD,GAAIA,aAAcC,EAAErB,MAAO,CACzB,MAAMgB,EAAKgB,EAAM,IACjBnB,EAAWS,IAAIN,EAAII,GACnBG,EAAmBP,EAAII,EAAIb,GAC3BI,EAAEM,GAAKD,UACEI,aAAcC,EAAEG,IAAK,CAC9B,MAAMR,EAAKgB,EAAMZ,EAAGa,UACpBpB,EAAWS,IAAIN,EAAII,GACnBV,EAAiBM,EAAII,EAAIb,GACzBI,EAAEM,GAAKD,OACEd,EAAoBkB,GAC7BT,EAAEM,GAAKG,EAC2B,eAAzBK,QAAQC,IAAIC,UACrBC,QAAQC,KAAK,qBAAsBT,IAKvCc,OAAOC,QAAQxB,GAAGyB,QAAQ,EAAEnB,EAAGD,MAC7B,MAAMI,EAAKR,EAAEO,IAAIF,GAEflB,EAAaiB,IACbI,aAAcC,EAAErB,OAChBqC,EAAUrB,EAAII,EAAGa,WAEjBpB,EAAWS,IAAIN,EAAII,GACnBG,EAAmBP,EAAII,EAAIb,KAE1BP,MAAMC,QAAQe,IACfrB,EAAcqB,IACdI,aAAcC,EAAEG,KAChBa,EAAUrB,EAAII,EAAGa,WAEjBpB,EAAWS,IAAIN,EAAII,GACnBV,EAAiBM,EAAII,EAAIb,IAEzBQ,EAAaC,EAAIC,KAKrBL,EAAEwB,QAAQ,CAAChB,EAAIH,KACb,MAAMD,EAAKL,EAAEM,GAEXlB,EAAaiB,IACbI,aAAcC,EAAErB,OAChBqC,EAAUrB,EAAII,EAAGa,WAEjBpB,EAAWS,IAAIN,EAAII,GACnBG,EAAmBP,EAAII,EAAIb,KAE1BP,MAAMC,QAAQe,IACfrB,EAAcqB,IACdI,aAAcC,EAAEG,KAChBa,EAAUrB,EAAII,EAAGa,WAEjBpB,EAAWS,IAAIN,EAAII,GACnBV,EAAiBM,EAAII,EAAIb,IAEzBuB,EAAaV,EAAIH,KAKrBqB,EAAU3B,EAAI4B,IACZA,EAAIH,QAASI,IACX,MAAMC,EAAOD,EAAG,GAChB,GAAoB,IAAhBC,EAAKC,OACP,OAEF,MAAMzB,EAAIwB,EAAK,GACf,GAAc,WAAVD,EAAG,GACL5B,EAAE+B,OAAO1B,WACU,QAAVuB,EAAG,GAAc,CAC1B,MAAMxB,EAAKL,EAAEM,GACPG,EAAKR,EAAEO,IAAIF,GACZoB,EAAUjB,aAAcC,EAAEuB,aAAexB,EAAGa,SAAWb,EAAIJ,IAC9DD,EAAaC,EAAIC,QAOzBL,EAAEiC,QAASC,IACTA,EAAMC,YAAYX,QAASnB,IACzB,MAAMG,EAAKR,EAAEO,IAAIF,QACNpB,IAAPuB,SACKT,EAAEM,GAETa,EAAaV,EAAIH,QAMZM,EAAqB,CAChCZ,EACAC,EACAL,EAAgB,MAEhB,MAAMM,EAAa,IAAIC,QAEjBkC,EAAkB,CAAChC,EAAOiC,KAC9B,GAAIlD,EAAaiB,GAAK,CACpB,MAAMI,EAAK,IAAIC,EAAErB,MACjBa,EAAWS,IAAIN,EAAII,GACnBG,EAAmBP,EAAII,EAAIb,GAC3BK,EAAEsC,OAAOD,EAAG,CAAC7B,YACJzB,EAAcqB,GAAK,CAC5B,MAAMI,EAAK,IAAIC,EAAEG,IACjBX,EAAWS,IAAIN,EAAII,GACnBV,EAAiBM,EAAII,EAAIb,GACzBK,EAAEsC,OAAOD,EAAG,CAAC7B,aACJhB,EAAsBY,GAG/B,UAAUmC,MAAM,sBAFhBvC,EAAEsC,OAAOD,EAAG,CAACjC,MAMXoC,EAAkB,CAAChC,EAAO6B,KAC9B,GAAI7B,aAAcC,EAAErB,MAAO,CACzB,MAAMgB,EAAKgB,EAAM,IACjBnB,EAAWS,IAAIN,EAAII,GACnBG,EAAmBP,EAAII,EAAIb,GAC3BI,EAAE0C,OAAOJ,EAAG,EAAGjC,WACNI,aAAcC,EAAEG,IAAK,CAC9B,MAAMR,EAAKgB,EAAMZ,EAAGa,UACpBpB,EAAWS,IAAIN,EAAII,GACnBV,EAAiBM,EAAII,GACrBT,EAAE0C,OAAOJ,EAAG,EAAGjC,YACNZ,EAAsBgB,GAG/B,UAAU+B,MAAM,sBAFhBxC,EAAE0C,OAAOJ,EAAG,EAAG7B,KAOnBT,EAAEyB,QAAQ,CAACpB,EAAIiC,KACb,MAAM7B,EAAKR,EAAEO,IAAI8B,GAEflD,EAAaiB,IACbI,aAAcC,EAAErB,OAChBqC,EAAUrB,EAAII,EAAGa,UAEbpB,EAAWM,IAAIH,KAAQI,IACzBP,EAAWS,IAAIN,EAAII,GACnBG,EAAmBP,EAAII,EAAIb,KAG5BP,MAAMC,QAAQe,IACfrB,EAAcqB,IACdI,aAAcC,EAAEG,KAChBa,EAAUrB,EAAII,EAAGa,UAEbpB,EAAWM,IAAIH,KAAQI,IACzBP,EAAWS,IAAIN,EAAII,GACnBV,EAAiBM,EAAII,EAAIb,IAG3BH,EAAsBY,IACtBZ,EAAsBgB,IACtBJ,IAAOI,GAIP4B,EAAgBhC,EAAIiC,KAKxBrC,EAAEwB,QAAQ,CAAChB,EAAI6B,KACb,MAAMjC,EAAKL,EAAEsC,GAEXlD,EAAaiB,IACbI,aAAcC,EAAErB,OAChBqC,EAAUrB,EAAII,EAAGa,UAEbpB,EAAWM,IAAIH,KAAQI,IACzBP,EAAWS,IAAIN,EAAII,GACnBG,EAAmBP,EAAII,EAAIb,KAG5BP,MAAMC,QAAQe,IACfrB,EAAcqB,IACdI,aAAcC,EAAEG,KAChBa,EAAUrB,EAAII,EAAGa,UAEbpB,EAAWM,IAAIH,KAAQI,IACzBP,EAAWS,IAAIN,EAAII,GACnBV,EAAiBM,EAAII,EAAIb,IAG3BH,EAAsBY,IACtBZ,EAAsBgB,IACtBJ,IAAOI,GAIPgC,EAAgBhC,EAAI6B,KAKxBtC,EAAE0C,OAAOzC,EAAE8B,QAGXJ,EAAU3B,EAAI4B,IACZ,MAAMe,EC/QoBf,CAAAA,IAC5B,MAAMe,EAAsBf,EAAIgB,QAASf,IACvC,GAAc,YAAVA,EAAG,IAA8B,WAAVA,EAAG,GAAiB,MAAO,GACtD,GAAqB,IAAjBA,EAAG,GAAGE,OAAc,MAAO,GAC/B,MAAMc,EAAQC,OAAOjB,EAAG,GAAG,IAC3B,OAAKiB,OAAOC,SAASF,GACd,CAAC,CAAChB,EAAG,GAAIgB,EAAOhB,EAAG,GAAIA,EAAG,KADG,KAIhCmB,EAA0B,CAC9BC,EACAC,KAEA,IAAIC,EAAI,EACJC,EAAmE,KACvE,KAAOH,EAAeE,EAAI,EAAIR,EAASZ,QAAQ,CAC7C,IACyC,QAAtCY,EAASM,EAAeE,EAAI,GAAG,IACQ,WAAtCR,EAASM,EAAeE,EAAI,GAAG,KACjCR,EAASM,EAAeE,EAAI,GAAG,GAAKD,GACpCP,EAASM,EAAeE,EAAI,GAAG,KAAOR,EAASM,GAAc,GAE7D,OAAOE,EAAI,EAEb,GACe,OAAbC,GACuC,QAAtCT,EAASM,EAAeE,EAAI,GAAG,IACQ,WAAtCR,EAASM,EAAeE,EAAI,GAAG,IACjCR,EAASM,EAAeE,EAAI,GAAG,KAAOD,GAAmBC,EAAI,SACvBjE,IAAtCyD,EAASM,EAAeE,EAAI,GAAG,MAIlB,OAAbC,GACAH,EAAeE,EAAI,EAAIR,EAASZ,QACM,QAAtCY,EAASM,EAAeE,EAAI,GAAG,SACOjE,IAAtCyD,EAASM,EAAeE,EAAI,GAAG,GAE/BC,EAAW,CAACH,EAAeE,EAAI,EAAGR,EAASM,EAAeE,EAAI,GAAG,IACjEA,GAAK,UAEQ,OAAbC,GACsC,QAAtCT,EAASM,EAAeE,EAAI,GAAG,IAC/BR,EAASM,EAAeE,EAAI,GAAG,KAC7BC,EAAS,IAAMD,EAAI,EAAIC,EAAS,UACIlE,IAAtCyD,EAASM,EAAeE,EAAI,GAAG,GAI/B,YAFAA,GAAK,OAhBLA,GAAK,EAqBT,aAGIE,EAAuB,CAC3BJ,EACAC,KAEA,IAAII,EAAI,EACR,KACEL,EAAeK,EAAI,EAAIX,EAASZ,QACM,WAAtCY,EAASM,EAAeK,EAAI,GAAG,IAC/BX,EAASM,EAAeK,EAAI,GAAG,KAAOJ,GAAmBI,EAAI,IAE7DA,GAAK,EAEP,OAAOA,GAGT,IAAIhB,EAAI,EACR,KAAOA,EAAIK,EAASZ,QAClB,GACsB,QAAnBY,EAASL,GAAG,IAAmC,WAAnBK,EAASL,GAAG,SACtBpD,IAAnByD,EAASL,GAAG,MAgBHA,EAAI,GAAwB,WAAnBK,EAASL,GAAG,GAAiB,CAC/C,MAAMY,EAAkBP,EAASL,GAAG,GAC9BgB,EAAID,EAAqBf,EAAGY,GAClC,GACyB,QAAvBP,EAASL,EAAI,GAAG,IAChBK,EAASL,EAAI,GAAG,KAAOY,GAAmBI,EAAI,IAC9CX,EAASL,EAAI,GAAG,KAAOK,EAASL,GAAG,GACnC,CACA,MAAMiB,EAAsB,CAC1B,SACAL,GAAmBI,EAAI,GACvBX,EAASL,EAAI,GAAG,QAChBpD,GAEFyD,EAASD,OAAOJ,EAAI,EAAG,GACvBK,EAASD,OAAOJ,EAAI,EAAIgB,EAAG,EAAGC,GAC9BjB,GAAK,OAELA,GAAK,OAGPA,GAAK,MApCL,CACA,MACMa,EAAIH,EAAwBV,EADVK,EAASL,GAAG,IAE1B,OAANa,GAOFR,EAASD,OAAOJ,EAAIa,EAAG,EANK,CAC1B,SACAR,EAASL,EAAIa,GAAG,GAChBR,EAASL,EAAIa,GAAG,QAChBjE,IAGFyD,EAASD,OAAOJ,EAAG,IAEnBA,GAAK,EA2BX,OAAOK,GD4JYa,CAAc5B,GAC3BF,EAAUzB,EAAEqB,SAAUtB,IAG1BN,EAASO,EAAEN,IAAKC,EAAM,KACpB+C,EAASlB,QAASI,IAChB,MAAMS,EAAIT,EAAG,GACb,GAAc,WAAVA,EAAG,GAIL,YAHI5B,EAAE8B,OAASO,GACbrC,EAAE+B,OAAOM,EAAG,IAIhB,MAAMjC,EAAKL,EAAEsC,QACFpD,IAAPmB,IAGU,QAAVwB,EAAG,IACD5B,EAAE8B,OAASO,GACbrC,EAAE+B,OAAOM,EAAG,GAEdD,EAAgBhC,EAAIiC,IACD,WAAVT,EAAG,IACZQ,EAAgBhC,EAAIiC,UAO5BrC,EAAEiC,QAASC,IACT,GAAIT,EAAU1B,EAAGC,EAAEqB,UACjB,OAEF,IAAImC,EAAS,EACbtB,EAAMuB,QAAQC,MAAMlC,QAASmC,IACvBA,EAAKH,SACPA,GAAUG,EAAKH,QAEbG,EAAK5B,QACPhC,EAAE0C,OAAOe,EAAQG,EAAK5B,QAEpB4B,EAAKrB,SACHlD,MAAMC,QAAQsE,EAAKrB,QACrBqB,EAAKrB,OAAOd,QAAQ,CAAChB,EAAI6B,KACvBG,EAAgBhC,EAAIgD,EAASnB,KAG/BG,EAAgBmB,EAAKrB,OAAwBkB,GAE/CA,GAAUG,EAAKrB,OAAOR"}